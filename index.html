<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mowing Map</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #search-box {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      #legend {
        background: white;
        padding: 10px;
        margin: 10px;
        border: 2px solid #000;
        font-size: 14px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEj4G1pfsw0eKoAHUfrDLesWf7XDV-9KE"></script>
    <script>
      let map;
      let markers = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -27.5, lng: 153.2 },
          zoom: 12,
        });

        fetch("data.geojson")
          .then((res) => res.json())
          .then((data) => {
            addFeaturesToMap(data);
          });

        const legend = document.createElement("div");
        legend.id = "legend";
        legend.innerHTML = `
          <h3>Legend</h3>
          <p><span style="color:blue;">●</span> 18 cuts/year</p>
          <p><span style="color:green;">●</span> 15 cuts/year</p>
          <p><span style="color:gray;">●</span> Other</p>
        `;
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend);
      }

      function colorForCuts(cuts) {
        if (cuts === 18) return "blue";
        if (cuts === 15) return "green";
        return "gray";
      }

      function createSvgIcon(color, label) {
        return {
          url:
            "data:image/svg+xml;charset=UTF-8," +
            encodeURIComponent(
              `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
                <circle cx="20" cy="20" r="10" fill="${color}" stroke="black" stroke-width="1"/>
                <text x="20" y="25" font-size="10" text-anchor="middle" fill="white">${label}</text>
              </svg>`
            ),
          scaledSize: new google.maps.Size(40, 40),
        };
      }

      function addFeaturesToMap(geojson) {
        markers.forEach((m) => m.setMap(null));
        markers = [];

        geojson.features.forEach((f) => {
          const props = f.properties || {};
          const geom = f.geometry;
          if (!geom) return;

          let lat = null,
            lng = null;

          if (geom.type === "Point") {
            lng = geom.coordinates[0];
            lat = geom.coordinates[1];
          } else if (geom.type === "Polygon") {
            const coords = geom.coordinates[0];
            let sumX = 0,
              sumY = 0;
            coords.forEach((c) => {
              sumX += c[0];
              sumY += c[1];
            });
            lng = sumX / coords.length;
            lat = sumY / coords.length;
          } else if (geom.type === "MultiPolygon") {
            const coords = geom.coordinates[0][0];
            let sumX = 0,
              sumY = 0;
            coords.forEach((c) => {
              sumX += c[0];
              sumY += c[1];
            });
            lng = sumX / coords.length;
            lat = sumY / coords.length;
          }

          if (typeof lat !== "number" || typeof lng !== "number") return;

          const cuts =
            props.CutsPerYear ||
            props["Cuts Per Year"] ||
            props.Cuts ||
            null;
          const uid =
            props.MowingID ||
            props.MOWINGID ||
            props.Mowing_Id ||
            props.UniqueID ||
            props.ID ||
            "";
          const label = uid || "";
          const color = colorForCuts(Number(cuts));
          const icon = createSvgIcon(color, label);

          const marker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            title: label || "Location",
            icon: icon,
          });

          const infowindow = new google.maps.InfoWindow({
            content:
              "<div><strong>" +
              (label || "Unknown") +
              "</strong><br/>CutsPerYear: " +
              (cuts || "N/A") +
              "</div>",
          });
          marker.addListener("click", () => infowindow.open(map, marker));
          markers.push(marker);
        });
      }

      function searchLocation() {
        const input = document.getElementById("search-input").value.trim().toLowerCase();
        if (!input) return;

        const match = markers.find((m) =>
          m.getTitle().toLowerCase().includes(input)
        );

        if (match) {
          map.setCenter(match.getPosition());
          map.setZoom(16);
          new google.maps.InfoWindow({
            content: match.getTitle(),
          }).open(map, match);
        } else {
          alert("No matching location found.");
        }
      }

      function resetMap() {
        map.setCenter({ lat: -27.5, lng: 153.2 });
        map.setZoom(12);
      }
    </script>
  </head>
  <body onload="initMap()">
    <div id="search-box">
      <input
        id="search-input"
        type="text"
        placeholder="Search Unique ID (e.g. M0123 or 123)"
      />
      <button onclick="searchLocation()">Go</button>
      <button onclick="resetMap()">Reset</button>
    </div>
    <div id="map"></div>
  </body>
</html>
