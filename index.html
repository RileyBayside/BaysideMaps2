<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mowing Locations Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; }
    #controls {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 5; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-family: Arial, sans-serif;
    }
    #search { width: 260px; padding:6px; font-size:14px; }
    #legend { position: absolute; right: 10px; top: 10px; z-index:5;
               background: rgba(255,255,255,0.95); padding:8px; border-radius:6px; font-family: Arial, sans-serif; }
    .legend-item { margin-bottom:6px; }
    .dot { display:inline-block; width:14px; height:14px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  </style>
</head>
<body>
<div id="controls">
  <input id="search" placeholder="Search Unique ID (e.g. M0123 or 123)" />
  <button id="btnSearch">Go</button>
  <button id="btnReset">Reset</button>
</div>
<div id="legend">
  <div><strong>Legend</strong></div>
  <div class="legend-item"><span class="dot" style="background:blue"></span>18 cuts/year</div>
  <div class="legend-item"><span class="dot" style="background:green"></span>15 cuts/year</div>
  <div class="legend-item"><span class="dot" style="background:gray"></span>Other</div>
</div>
<div id="map"></div>

<script>
const API_KEY = "AIzaSyAEj4G1pfsw0eKoAHUfrDLesWf7XDV-9KE";

// Utility: create an SVG marker with text and outline
function createSvgIcon(fillColor, labelText) {
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="110" height="40" viewBox="0 0 110 40">
    <circle cx="20" cy="20" r="12" fill="${fillColor}" stroke="#000" stroke-width="2"/>
    <text x="20" y="24" font-size="12" font-family="Arial" font-weight="700" text-anchor="middle" fill="#ffffff" stroke="#000000" stroke-width="2" paint-order="stroke">${labelText}</text>
    <rect x="40" y="8" width="65" height="24" rx="4" ry="4" fill="#ffffff" stroke="#333" />
    <text x="72" y="24" font-size="12" font-family="Arial" text-anchor="middle" fill="#333">${labelText}</text>
  </svg>`;
  return {
    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
    scaledSize: new google.maps.Size(110,40),
    anchor: new google.maps.Point(20,20)
  };
}

let map;
let markers = [];
let geojsonData;

// Decide color by CutsPerYear
function colorForCuts(cuts) {
  if (cuts === 18) return 'blue';
  if (cuts === 15) return 'green';
  // fallback: use gray
  return 'gray';
}

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: -27.4705, lng: 153.0260 },
    zoom: 11
  });

  fetch('data.geojson').then(r => r.json()).then(json => {
    geojsonData = json;
    addFeaturesToMap(json);
  });

  document.getElementById('btnSearch').addEventListener('click', () => {
    doSearch(document.getElementById('search').value);
  });
  document.getElementById('search').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') doSearch(e.target.value);
  });
  document.getElementById('btnReset').addEventListener('click', resetView);
}

function addFeaturesToMap(geojson) {
  markers.forEach(m => m.setMap(null));
  markers = [];

  geojson.features.forEach(f => {
    const props = f.properties || {};
    const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates.slice() : null;
    if (!coords) return;
    // GeoJSON coordinates are [lng,lat]
    const lng = coords[0];
    const lat = coords[1];
    // prefer CutsPerYear and MowingID fields based on your data
    const cuts = props.CutsPerYear || props['Cuts Per Year'] || props.Cuts || null;
    const uid = props.MowingID || props.MOWINGID || props.Mowing_Id || props.UniqueID || props['Unique Id'] || props.ID || props.Id || '';
    const label = uid || '';
    const color = colorForCuts(Number(cuts));
    const icon = createSvgIcon(color, label);

    const marker = new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: label || 'Location',
      icon: icon
    });

    const infowindow = new google.maps.InfoWindow({
      content: '<div><strong>' + (label || 'Unknown') + '</strong><br/>CutsPerYear: ' + (cuts || 'N/A') + '</div>'
    });
    marker.addListener('click', () => infowindow.open(map, marker));
    markers.push(marker);
  });
}

// Smart search: accepts '123' -> 'M0123' or full 'M0123'
function normalizeSearch(q) {
  if (!q) return '';
  q = q.trim();
  // If numeric only, try to pad to 4 digits and prefix M
  if (/^\d+$/.test(q)) {
    const padded = q.padStart(4,'0');
    return 'M' + padded;
  }
  // If starts with digits, find numeric part and prefix M
  const m = q.match(/(\d+)/);
  if (m) {
    return 'M' + m[1].padStart(4,'0');
  }
  return q.toUpperCase();
}

function doSearch(q) {
  const n = normalizeSearch(q);
  if (!n || !geojsonData) return alert('Enter a search term.');
  // find feature where MowingID equals n or includes n
  let found = null;
  for (const f of geojsonData.features) {
    const props = f.properties || {};
    const uid = (props.MowingID || props.MOWINGID || props.Mowing_Id || props.UniqueID || props.ID || '').toString().toUpperCase();
    if (uid === n || uid.includes(n) || uid.replace(/^M0*/, '') === n.replace(/^M0*/, '')) {
      found = f;
      break;
    }
  }
  if (!found) return alert('No matching location found for "' + q + '" (normalized: ' + n + ').');
  const coords = found.geometry.coordinates;
  const latlng = { lat: coords[1], lng: coords[0] };
  map.setCenter(latlng);
  map.setZoom(17);
  // Optionally open the marker's infowindow
  const uid = (found.properties.MowingID || found.properties.MOWINGID || found.properties.UniqueID || '').toString();
  const marker = markers.find(m => m.getTitle() && m.getTitle().toString().toUpperCase() === uid.toUpperCase());
  if (marker) google.maps.event.trigger(marker, 'click');
}

function resetView() {
  map.setCenter({ lat: -27.4705, lng: 153.0260 });
  map.setZoom(11);
}

// Load Google Maps script dynamically
function loadScript() {
  const s = document.createElement('script');
  s.src = 'https://maps.googleapis.com/maps/api/js?key=' + API_KEY + '&callback=initMap';
  s.defer = true;
  s.async = true;
  document.head.appendChild(s);
}

window.onload = loadScript;
</script>
</body>
</html>
