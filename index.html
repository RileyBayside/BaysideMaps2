<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet KML Map — Satellite + Fuzzy Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="topbar">
    <div id="searchBox">
      <input id="searchInput" placeholder="Search by Unique ID or MowingID (e.g. M0123)" autocomplete="off">
      <div id="suggestions" class="suggestions"></div>
    </div>
    <div id="legend">Satellite imagery • Colors: 15 = Green, 18 = Blue</div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
  var map = L.map('map');
  var sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri'
  }).addTo(map);

  var kmlLayer = L.featureGroup().addTo(map);

  function levenshtein(a,b){if(a===b)return 0;var al=a.length,bl=b.length;if(al===0)return bl;if(bl===0)return al;var v0=new Array(bl+1),v1=new Array(bl+1);for(var j=0;j<=bl;j++)v0[j]=j;for(var i=0;i<al;i++){v1[0]=i+1;for(var j=0;j<bl;j++){var cost=a[i]===b[j]?0:1;v1[j+1]=Math.min(v1[j]+1,v0[j+1]+1,v0[j]+cost);}var tmp=v0;v0=v1;v1=tmp;}return v0[bl];}

  omnivore.kml('data.kml')
    .on('ready', function(e) {
      var layer = e.target;
      layer.eachLayer(function(l) {
        var props = l.feature && l.feature.properties ? l.feature.properties : {};
        // Style by CutsPerYear
        var cuts = props['CutsPerYear'] || props['cutsperyear'] || props['cuts'] || null;
        var color = 'red';
        if (String(cuts) === '15') color = 'green';
        if (String(cuts) === '18') color = 'blue';
        if (l.setStyle) l.setStyle({color:color, fillColor:color, weight:2, fillOpacity:0.4});

        // Popup
        var html = '<div class="popup"><table>';
        for (var k in props) {
          html += '<tr><th>'+k+'</th><td>'+props[k]+'</td></tr>';
        }
        html += '</table></div>';
        l.bindPopup(html);
        kmlLayer.addLayer(l);
      });
      if (kmlLayer.getBounds().isValid()) map.fitBounds(kmlLayer.getBounds(), {padding:[20,20]});
      buildIndexFromLayer(kmlLayer);
    });

  var index = [];
  function normalize(s){return String(s||'').trim().toLowerCase();}
  function getPossibleId(props){
    var keys=['MowingID','Mowing Id','Mowing_ID','Unique ID','UniqueID','name','Name','id','ID'];
    for (var i=0;i<keys.length;i++){
      for (var pk in props){
        if (pk.replace(/\s+/g,'').toLowerCase()===keys[i].replace(/\s+/g,'').toLowerCase())
          return props[pk];
      }
    }
    return null;
  }
  function buildIndexFromLayer(group){
    index=[];
    group.eachLayer(function(l){
      var props=l.feature&&l.feature.properties?l.feature.properties:{};
      var idVal=getPossibleId(props)||'';
      var label=idVal||(props.name||'');
      index.push({idVal:String(idVal),layer:l,label:String(label)});
    });
    setupSearchUI();
  }

  var input=document.getElementById('searchInput'),suggBox=document.getElementById('suggestions');
  function setupSearchUI(){
    input.addEventListener('input',onInput);
    input.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();if(suggBox.firstChild){selectSuggestion(suggBox.firstChild.dataset.index);}else{performSearch(input.value);}}});
    document.addEventListener('click',function(e){if(!document.getElementById('searchBox').contains(e.target))suggBox.style.display='none';});
  }

  function onInput(e){
    var q=normalize(e.target.value);
    if(!q){suggBox.style.display='none';return;}
    var matches=[];
    for(var i=0;i<index.length;i++){
      var item=index[i];var val=normalize(item.idVal||item.label||'');if(!val)continue;
      if(val.indexOf(q)!==-1||val.replace(/[^0-9]/g,'').indexOf(q)!==-1){matches.push({score:0,idx:i});continue;}
      var dist=levenshtein(q,val);var ratio=dist/Math.max(q.length,val.length);if(ratio<=0.5){matches.push({score:ratio,idx:i});}
    }
    matches.sort(function(a,b){return a.score-b.score;});renderSuggestions(matches.slice(0,10));
  }

  function renderSuggestions(matches){
    suggBox.innerHTML='';if(!matches.length){suggBox.style.display='none';return;}
    for(var i=0;i<matches.length;i++){var it=index[matches[i].idx];var div=document.createElement('div');div.className='suggestion';div.textContent=(it.idVal||it.label);div.dataset.index=matches[i].idx;div.addEventListener('click',function(){selectSuggestion(this.dataset.index);});suggBox.appendChild(div);}suggBox.style.display='block';
  }
  function selectSuggestion(idx){var it=index[idx];if(!it)return;focusLayer(it.layer);input.value=it.idVal||it.label;suggBox.style.display='none';}
  function performSearch(q){q=normalize(q);if(!q)return;for(var i=0;i<index.length;i++){var it=index[i];if(normalize(it.idVal)===q||normalize(it.label)===q||normalize(it.idVal.replace(/[^0-9]/g,''))===q){selectSuggestion(i);return;}}var best=null,bestScore=999;for(var i=0;i<index.length;i++){var val=normalize(index[i].idVal||index[i].label||'');var dist=levenshtein(q,val);if(dist<bestScore){bestScore=dist;best=i;}}if(best!==null){selectSuggestion(best);}else{alert('No match found');}}
  function focusLayer(layer){if(!layer)return;if(layer.getBounds){try{map.fitBounds(layer.getBounds(),{maxZoom:18,padding:[30,30]});}catch(e){if(layer.getLatLng)map.setView(layer.getLatLng(),18);}}else if(layer.getLatLng){map.setView(layer.getLatLng(),18);}if(layer.openPopup)layer.openPopup();}
  </script>
</body>
</html>